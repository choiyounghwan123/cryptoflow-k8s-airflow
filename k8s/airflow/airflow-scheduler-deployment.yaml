apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-scheduler
  namespace: airflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: airflow-scheduler
  template:
    metadata:
      labels:
        app: airflow-scheduler
    spec:
      serviceAccountName: airflow
      containers:
      # ê¸°ì¡´ Airflow Scheduler ì»¨í…Œì´ë„ˆ (ìˆ˜ì •ë¨)
      - name: airflow-scheduler
        image: apache/airflow:2.7.1-python3.11
        command:
          - bash
          - -c
          - airflow scheduler
        envFrom:
        - configMapRef:
            name: airflow-config
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              name: airflow-secret
              key: fernet-key
        # PostgreSQL ì—°ê²° ì •ë³´
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: airflow-secret
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: airflow-secret
              key: postgres-password
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: airflow-secret
              key: postgres-db
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgresql-service:5432/$(POSTGRES_DB)"
        # ğŸ†• DAG ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì¶”ê°€
        volumeMounts:
        - name: dags-volume
          mountPath: /opt/airflow/git-dags
          readOnly: true
      
      # ğŸ†• Git Sync ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆ ì¶”ê°€
      - name: git-sync
        image: registry.k8s.io/git-sync/git-sync:v3.6.9
        env:
        - name: GIT_SYNC_REPO
          value: "git@github.com:choiyounghwan123/cryptoflow-k8s-airflow.git"
        - name: GIT_SYNC_BRANCH
          value: "main"
        - name: GIT_SYNC_ROOT
          value: "/tmp/git"
        # GIT_SYNC_DEST ì œê±° - ì „ì²´ ë¦¬í¬ì§€í† ë¦¬ ë™ê¸°í™”
        - name: GIT_SYNC_PERIOD
          value: "10s"
        - name: GIT_SYNC_SSH
          value: "true"
        - name: GIT_SSH_KEY_FILE
          value: "/etc/git-secret/gitSshKey"
        - name: GIT_SYNC_PERMISSIONS
          value: "0755"
        - name: GIT_KNOWN_HOSTS
          value: "false"
        volumeMounts:
        - name: dags-volume
          mountPath: /tmp/git
        - name: git-ssh-key
          mountPath: /etc/git-secret
          readOnly: true
        securityContext:
          runAsUser: 0
          runAsGroup: 0
      
      # ğŸ†• ë³¼ë¥¨ ì •ì˜ ì¶”ê°€
      volumes:
      # DAG íŒŒì¼ ê³µìœ ìš© ì„ì‹œ ë³¼ë¥¨
      - name: dags-volume
        emptyDir: {}
      # SSH í‚¤ Secret ë³¼ë¥¨
      - name: git-ssh-key
        secret:
          secretName: airflow-ssh-secret
          defaultMode: 0400
